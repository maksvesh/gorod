<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Змейка - Темный город</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #0a0a12;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 900px;
            width: 100%;
            gap: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .title {
            font-size: 2.2rem;
            color: #00ffff;
            margin-bottom: 8px;
            text-shadow: 0 0 10px #00ffff;
        }

        #score {
            font-size: 1.4rem;
            margin-bottom: 8px;
            color: #ffff00;
        }

        #message {
            font-size: 1rem;
            height: 24px;
            margin-bottom: 8px;
            color: #ff00aa;
            text-align: center;
        }

        .content-container {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
            align-items: flex-start;
        }

        .game-container {
            position: relative;
        }

        canvas {
            border: 3px solid #00ffff;
            border-radius: 5px;
            background-color: #0d1b2a;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 250px;
        }

        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #004466;
            border-radius: 5px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
        }

        .info-label {
            font-size: 0.9rem;
            color: #80ffff;
        }

        .info-value {
            font-size: 1.1rem;
            color: #ffff00;
            font-weight: bold;
        }

        .apple-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #004466;
            border-radius: 5px;
        }

        .apple-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .apple-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #fff;
        }

        .green { background-color: #4ade80; }
        .red { background-color: #f87171; }

        .quest-info {
            background: rgba(0, 30, 60, 0.8);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }

        .quest-target {
            color: #00ff00;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .quest-progress {
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .controls {
            margin: 10px 0;
            font-size: 0.9rem;
            color: #ccc;
            text-align: center;
            padding: 15px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #004466;
            border-radius: 5px;
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            justify-content: center;
        }

        .game-btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #004466, #0088aa);
            color: #ffffff;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            transform: perspective(500px) rotateX(5deg);
            transition: all 0.3s;
            border: 1px solid #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .game-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .game-btn:hover {
            transform: perspective(500px) rotateX(0deg) translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 200, 255, 0.4);
            background: linear-gradient(45deg, #006688, #00aacc);
        }

        .game-btn:hover::before {
            left: 100%;
        }

        #restart-btn {
            background: linear-gradient(45deg, #004466, #0088aa);
        }

        #back-btn {
            background: linear-gradient(45deg, #550066, #8800aa);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        @media (max-width: 900px) {
            .content-container {
                flex-direction: column;
                align-items: center;
            }
            
            .side-panel {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div class="header">
            <div class="title">ЗМЕЙКА</div>
            <div id="score">Счет: 0</div>
            <div id="message"></div>
        </div>

        <div class="content-container">
            <div class="game-container">
                <canvas id="game" width="400" height="400"></canvas>
            </div>
            
            <div class="side-panel">
                <div class="quest-info" id="quest-info">
                    <div class="quest-target">Задание: Набрать 30 очков в игре Змейка</div>
                    <div>Текущий прогресс: <span id="quest-progress-text">0/30</span></div>
                    <div class="quest-progress">
                        <div class="quest-progress-fill" id="quest-progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="quest-status">Продолжайте играть!</div>
                </div>
                
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">Длина змейки</div>
                        <div class="info-value" id="snake-length">1</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Съедено яблок</div>
                        <div class="info-value" id="apples-eaten">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Время</div>
                        <div class="info-value" id="game-time">0:00</div>
                    </div>
                </div>
                
                <div class="apple-info">
                    <div class="apple-info-item">
                        <div class="apple-color green"></div>
                        <span>+1 очко, +1 длина</span>
                    </div>
                    <div class="apple-info-item">
                        <div class="apple-color red"></div>
                        <span>-1 очко, -1 длина</span>
                    </div>
                </div>
                
                <div class="controls">
                    <div>Управление: стрелки клавиатуры</div>
                    <div>Избегайте красных яблок и столкновений с собой!</div>
                </div>
            </div>
        </div>
        
        <div class="buttons-container">
            <button id="restart-btn" class="game-btn">Перезапуск</button>
            <a href="weekly_quests.html" id="back-btn" class="game-btn">Назад к заданиям</a>
        </div>
    </div>
<script>
    const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const scoreElement = document.getElementById('score');
const messageElement = document.getElementById('message');
const restartBtn = document.getElementById('restart-btn');
const snakeLengthElement = document.getElementById('snake-length');
const applesEatenElement = document.getElementById('apples-eaten');
const gameTimeElement = document.getElementById('game-time');
const questProgressBar = document.getElementById('quest-progress-bar');
const questProgressText = document.getElementById('quest-progress-text');
const questStatusElement = document.getElementById('quest-status');
const questTargetElement = document.querySelector('.quest-target');

const grid = 20;
let count = 0;
let score = 0;
let snakeLength = 1;
let applesEaten = 0;
let gameTime = 0;
let gameTimer;
let isGameActive = false;
let currentQuestId = null;
let currentTargetScore = 30; // Значение по умолчанию

const snake = {
    x: 200,
    y: 200,
    dx: grid,
    dy: 0,
    cells: [],
    maxCells: 1
};

let greenApple = { x: 300, y: 300 };
let redApple = { x: 100, y: 300 };

// Класс для управления заданиями
class QuestManager {
    static async loadQuestInfo() {
        const questId = localStorage.getItem('current_snake_quest');
        const userId = localStorage.getItem('user_id');
        
        if (!questId || !userId) {
            console.log('No active quest found');
            return null;
        }

        try {
            const response = await fetch('weekly_quests.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'get_quests',
                    user_id: userId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    const currentQuest = result.quests.find(q => q.id == questId);
                    return currentQuest || null;
                }
            }
        } catch (error) {
            console.error('Error loading quest info:', error);
        }
        
        return null;
    }

    static async updateQuestProgress(score) {
        const questId = localStorage.getItem('current_snake_quest');
        const userId = localStorage.getItem('user_id');
        
        if (!questId || !userId) return null;

        try {
            const response = await fetch('weekly_quests.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'update_snake_score',
                    user_id: userId,
                    quest_id: questId,
                    score: score
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                return result;
            }
        } catch (error) {
            console.error('Error updating quest progress:', error);
        }
        
        return null;
    }
}

// Получаем ID задания из localStorage
function getCurrentQuestId() {
    return localStorage.getItem('current_snake_quest');
}

// Загружаем информацию о задании
async function loadQuestInfo() {
    const questId = localStorage.getItem('current_snake_quest');
    const userId = localStorage.getItem('user_id');
    
    if (!questId || !userId) {
        // Если нет активного задания, используем значения по умолчанию
        currentTargetScore = 30;
        updateQuestDisplay(0);
        return;
    }

    try {
        // Получаем target_score из localStorage (переданный из карточки)
        const storedTargetScore = localStorage.getItem('current_target_score');
        if (storedTargetScore) {
            currentTargetScore = parseInt(storedTargetScore);
        }

        // Обновляем отображение с правильным target_score
        updateQuestInfo(currentTargetScore);
        
        // Загружаем текущий прогресс
        const response = await fetch('weekly_quests.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'get_quests',
                user_id: userId
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.quests) {
                const currentQuest = result.quests.find(q => q.id == questId);
                if (currentQuest) {
                    updateQuestDisplay(currentQuest.user_progress || 0);
                } else {
                    updateQuestDisplay(0);
                }
            }
        }
    } catch (error) {
        console.error('Error loading quest info:', error);
        updateQuestDisplay(0);
    }
}

// Обновляем отображение информации о задании
function updateQuestInfo(targetScore) {
    questTargetElement.textContent = `Задание: Набрать ${targetScore} очков в игре Змейка`;
    currentTargetScore = targetScore;
}

// Обновляем отображение прогресса задания
function updateQuestDisplay(progress) {
    const progressPercent = Math.min((progress / currentTargetScore) * 100, 100);
    questProgressBar.style.width = progressPercent + '%';
    questProgressText.textContent = `${progress}/${currentTargetScore}`;
    
    if (progress >= currentTargetScore) {
        questStatusElement.textContent = 'Задание выполнено! Вернитесь к заданиям для получения награды.';
        questStatusElement.style.color = '#00ff00';
    } else {
        questStatusElement.textContent = 'Продолжайте играть!';
        questStatusElement.style.color = '#ffff00';
    }
}

// Отправляем прогресс на сервер
async function updateQuestProgress(newScore) {
    const questId = getCurrentQuestId();
    if (!questId) return;

    try {
        const result = await QuestManager.updateQuestProgress(newScore);
        if (result && result.success) {
            updateQuestDisplay(result.progress);
            if (result.quest_completed) {
                showMessage('Задание выполнено! Вернитесь к заданиям для получения награды.', 'success', 5000);
            }
        }
    } catch (error) {
        console.error('Error updating quest progress:', error);
    }
}

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}

// Функция для проверки валидности позиции
function isValidPosition(x, y, excludePositions = []) {
    // Проверяем, что позиция не занята змеей
    if (snake.cells.some(cell => cell.x === x && cell.y === y)) {
        return false;
    }
    
    // Проверяем, что позиция не совпадает с исключенными позициями
    for (const pos of excludePositions) {
        if (pos.x === x && pos.y === y) {
            return false;
        }
    }
    
    return true;
}

function placeApples() {
    const excludePositions = [];
    
    // Размещаем зеленое яблоко
    let attempts = 0;
    do {
        greenApple.x = getRandomInt(0, 20) * grid;
        greenApple.y = getRandomInt(0, 20) * grid;
        attempts++;
    } while (!isValidPosition(greenApple.x, greenApple.y) && attempts < 100);
    
    // Добавляем позицию зеленого яблока в исключения для красного
    excludePositions.push({x: greenApple.x, y: greenApple.y});
    
    // Размещаем красное яблоко
    attempts = 0;
    do {
        redApple.x = getRandomInt(0, 20) * grid;
        redApple.y = getRandomInt(0, 20) * grid;
        attempts++;
    } while (!isValidPosition(redApple.x, redApple.y, excludePositions) && attempts < 100);
}

function updateScore() {
    scoreElement.textContent = 'Счет: ' + score;
    snakeLengthElement.textContent = snakeLength;
    applesEatenElement.textContent = applesEaten;
}

function showMessage(text, type = 'info', duration = 1000) {
    messageElement.textContent = text;
    messageElement.style.color = type === 'success' ? '#00ff00' : 
                               type === 'error' ? '#ff0000' : 
                               type === 'warning' ? '#ffff00' : '#ff00aa';
    
    setTimeout(() => {
        messageElement.textContent = '';
    }, duration);
}

function startGameTimer() {
    gameTime = 0;
    clearInterval(gameTimer);
    gameTimer = setInterval(() => {
        gameTime++;
        const minutes = Math.floor(gameTime / 60);
        const seconds = gameTime % 60;
        gameTimeElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopGameTimer() {
    clearInterval(gameTimer);
}

function loop() {
    if (!isGameActive) return;
    
    requestAnimationFrame(loop);
    
    if (++count < 10) return;
    count = 0;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Рисуем сетку
    ctx.strokeStyle = 'rgba(0, 255, 255, 0.1)';
    ctx.lineWidth = 1;
    for (let x = 0; x <= canvas.width; x += grid) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    for (let y = 0; y <= canvas.height; y += grid) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }

    snake.x += snake.dx;
    snake.y += snake.dy;

    // Проверка границ
    if (snake.x < 0) snake.x = canvas.width - grid;
    else if (snake.x >= canvas.width) snake.x = 0;
    if (snake.y < 0) snake.y = canvas.height - grid;
    else if (snake.y >= canvas.height) snake.y = 0;

    snake.cells.unshift({ x: snake.x, y: snake.y });
    if (snake.cells.length > snake.maxCells) {
        snake.cells.pop();
    }

    // Отрисовка яблок
    ctx.fillStyle = '#4ade80';
    ctx.fillRect(greenApple.x, greenApple.y, grid - 2, grid - 2);
    ctx.strokeStyle = '#00ff00';
    ctx.strokeRect(greenApple.x, greenApple.y, grid - 2, grid - 2);
    
    ctx.fillStyle = '#f87171';
    ctx.fillRect(redApple.x, redApple.y, grid - 2, grid - 2);
    ctx.strokeStyle = '#ff0000';
    ctx.strokeRect(redApple.x, redApple.y, grid - 2, grid - 2);

    // Отрисовка змейки
    snake.cells.forEach(function(cell, index) {
        if (index === 0) {
            // Голова змейки
            ctx.fillStyle = '#00ffff';
            ctx.fillRect(cell.x, cell.y, grid - 2, grid - 2);
            ctx.strokeStyle = '#0088ff';
            ctx.strokeRect(cell.x, cell.y, grid - 2, grid - 2);
            
            // Глаза
            ctx.fillStyle = '#000';
            if (snake.dx > 0) { // Движение вправо
                ctx.fillRect(cell.x + grid - 8, cell.y + 4, 3, 3);
                ctx.fillRect(cell.x + grid - 8, cell.y + grid - 7, 3, 3);
            } else if (snake.dx < 0) { // Движение влево
                ctx.fillRect(cell.x + 2, cell.y + 4, 3, 3);
                ctx.fillRect(cell.x + 2, cell.y + grid - 7, 3, 3);
            } else if (snake.dy > 0) { // Движение вниз
                ctx.fillRect(cell.x + 4, cell.y + grid - 8, 3, 3);
                ctx.fillRect(cell.x + grid - 7, cell.y + grid - 8, 3, 3);
            } else { // Движение вверх
                ctx.fillRect(cell.x + 4, cell.y + 2, 3, 3);
                ctx.fillRect(cell.x + grid - 7, cell.y + 2, 3, 3);
            }
        } else {
            // Тело змейки
            ctx.fillStyle = '#0088ff';
            ctx.fillRect(cell.x, cell.y, grid - 2, grid - 2);
            ctx.strokeStyle = '#0066cc';
            ctx.strokeRect(cell.x, cell.y, grid - 2, grid - 2);
        }
    });

    // Проверка столкновений с зеленым яблоком
    if (snake.cells[0].x === greenApple.x && snake.cells[0].y === greenApple.y) {
        snake.maxCells++;
        snakeLength = snake.maxCells;
        score++;
        applesEaten++;
        updateScore();
        showMessage('+1 очко, +1 длина!', 'success');
        placeApples(); // Новое яблоко гарантированно не появится в змее
        
        // Обновляем прогресс задания
        updateQuestProgress(score);
    }

    // Проверка столкновений с красным яблоком
    if (snake.cells[0].x === redApple.x && snake.cells[0].y === redApple.y) {
        if (snake.maxCells > 1) {
            snake.maxCells--;
            snakeLength = snake.maxCells;
            score = Math.max(0, score - 1);
            updateScore();
            // Удаляем последний сегмент змейки
            if (snake.cells.length > snake.maxCells) {
                snake.cells.splice(snake.maxCells);
            }
            showMessage('-1 очко, -1 длина!', 'warning');
        } else {
            // Если длина минимальная, только отнимаем очко
            score = Math.max(0, score - 1);
            updateScore();
            showMessage('-1 очко! Мин. длина!', 'warning');
        }
        placeApples(); // Новое яблоко гарантированно не появится в змее
        
        // Обновляем прогресс задания
        updateQuestProgress(score);
    }

    // Проверка столкновения с собой
    for (let i = 1; i < snake.cells.length; i++) {
        if (snake.cells[0].x === snake.cells[i].x && snake.cells[0].y === snake.cells[i].y) {
            gameOver();
            return;
        }
    }
}

function gameOver() {
    isGameActive = false;
    stopGameTimer();
    showMessage('Игра окончена! Ваш счет: ' + score, 'error', 3000);
    
    // Отправляем финальный счет
    updateQuestProgress(score);
}

function resetGame() {
    snake.x = 200;
    snake.y = 200;
    snake.cells = [];
    snake.maxCells = 1;
    snake.dx = grid;
    snake.dy = 0;
    snakeLength = 1;
    score = 0;
    applesEaten = 0;
    updateScore();
    showMessage('Начало игры!', 'info');
    placeApples();
    startGameTimer();
    isGameActive = true;
    requestAnimationFrame(loop);
}

// Управление с клавиатуры
document.addEventListener('keydown', function(e) {
    if (!isGameActive && (e.which === 37 || e.which === 38 || e.which === 39 || e.which === 40)) {
        resetGame();
        return;
    }

    if (e.which === 37 && snake.dx === 0) {
        snake.dx = -grid; snake.dy = 0;
    } else if (e.which === 38 && snake.dy === 0) {
        snake.dy = -grid; snake.dx = 0;
    } else if (e.which === 39 && snake.dx === 0) {
        snake.dx = grid; snake.dy = 0;
    } else if (e.which === 40 && snake.dy === 0) {
        snake.dy = grid; snake.dx = 0;
    }
});

restartBtn.addEventListener('click', resetGame);

// Инициализация игры
async function initGame() {
    updateScore();
    placeApples();
    await loadQuestInfo(); // Загружаем информацию о задании
    resetGame();
}

// Запуск игры при загрузке страницы
window.addEventListener('load', initGame);
</script>
</body>
</html>