name: Save Game Results

on:
  workflow_dispatch:    # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  repository_dispatch:  # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ API
    types: [game_results]
  push:                 # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ –≤ main
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *' # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å

jobs:
  save-results:
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITO }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create results directory
      run: mkdir -p game-results
        
    - name: Process game results
      env:
        GAME_DATA: ${{ github.event.client_payload.game_data }}
        COMMIT_MESSAGE: ${{ github.event.client_payload.commit_message }}
        PLAYER_NAME: ${{ github.event.client_payload.player_name }}
      run: |
        if [ -n "$GAME_DATA" ]; then
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          FILENAME="result_${TIMESTAMP}_${PLAYER_NAME}.json"
          echo "$GAME_DATA" > "game-results/$FILENAME"
          echo "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: $FILENAME"
        else
          echo "‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
        fi
        
    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add game-results/
        git diff --staged --quiet || git commit -m "üéÆ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã [automated]"
        git push
