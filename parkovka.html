<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Парковка</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --dark-bg: rgba(0, 0, 0, 0.8);
            --light-text: #ffffff;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: var(--light-text);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            width: 100vw;
            touch-action: none;
            position: fixed;
        }
        
        .header {
            text-align: center;
            padding: 12px 16px;
            width: 100%;
            background: var(--dark-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: clamp(18px, 5vw, 24px);
            font-weight: 700;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            position: relative;
        }
        
        .game-ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            background: var(--dark-bg);
            padding: 12px 16px;
            border-radius: 16px;
            margin: 8px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 10;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            max-height: 60vh;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            touch-action: none;
            background: #1a1a1a;
        }
        
        .controls {
            display: flex;
            gap: 12px;
        }
        
        button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--light-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            min-width: 120px;
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .mobile-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25vh;
            min-height: 150px;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .steering-buttons {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .steering-button {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light-text);
            font-size: 32px;
            font-weight: bold;
            touch-action: none;
            user-select: none;
            transition: all 0.1s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .steering-button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .gas-button {
            background: rgba(76, 175, 80, 0.7);
            border: 3px solid rgba(76, 175, 80, 0.9);
        }
        
        .gas-button:active {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-bg);
            color: var(--light-text);
            padding: 12px 24px;
            border-radius: 24px;
            text-align: center;
            z-index: 1000;
            display: none;
            animation: fadeInOut 3s ease-in-out;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 16px;
            max-width: 90%;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes fadeInOut {
            0%, 100% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(-20px); 
            }
            10%, 90% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0); 
            }
        }
        
        .success-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.4) 0%, transparent 70%);
            animation: successPulse 2s ease-in-out;
            display: none;
            z-index: 500;
            pointer-events: none;
        }
        
        @keyframes successPulse {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        .control-hints {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: var(--light-text);
            padding: 8px 16px;
            border-radius: 20px;
            text-align: center;
            font-size: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            z-index: 10;
        }
        
        /* Мобильные стили */
        @media (max-width: 768px) {
            .game-container {
                padding: 0;
            }
            
            .game-area {
                padding: 4px;
                justify-content: flex-start;
            }
            
            .game-ui {
                margin: 4px;
                padding: 10px 14px;
                border-radius: 12px;
            }
            
            .mobile-controls {
                display: flex;
            }
            
            .control-hints {
                display: block;
            }
            
            button {
                min-width: 100px;
                padding: 8px 16px;
            }
            
            .steering-button {
                width: 70px;
                height: 70px;
                font-size: 28px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }
            
            .game-ui {
                padding: 8px 12px;
            }
            
            .mobile-controls {
                padding: 16px;
                height: 22vh;
            }
            
            .steering-button {
                width: 65px;
                height: 65px;
                font-size: 26px;
            }
            
            .steering-buttons {
                gap: 25px;
            }
            
            .stats {
                gap: 15px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .stat-label {
                font-size: 12px;
            }
        }
        
        @media (max-width: 360px) {
            .mobile-controls {
                padding: 12px;
            }
            
            .steering-button {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .steering-buttons {
                gap: 20px;
            }
            
            button {
                min-width: 90px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚗 3D Парковка</h1>
    </div>
    
    <div class="game-container">
        <div class="game-area">
            <div class="game-ui">
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Очки</div>
                        <div class="stat-value" id="score">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Уровень</div>
                        <div class="stat-value" id="level">1</div>
                    </div>
                </div>
                <div class="controls">
                    <button id="startButton">Начать игру</button>
                </div>
            </div>
            
            <canvas id="gameCanvas"></canvas>
            <div class="success-effect" id="successEffect"></div>
            
            <div class="control-hints">
                Используйте кнопки для управления машиной
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <!-- Мобильное управление -->
    <div class="mobile-controls" id="mobileControls">
        <div class="steering-buttons">
            <div class="steering-button" id="leftButton">←</div>
            <div class="steering-button gas-button" id="gasButton">⛽</div>
            <div class="steering-button" id="rightButton">→</div>
        </div>
    </div>

    <!-- Three.js библиотека -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // Элементы DOM
        const gameCanvas = document.getElementById('gameCanvas');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const startButton = document.getElementById('startButton');
        const notification = document.getElementById('notification');
        const successEffect = document.getElementById('successEffect');
        const mobileControls = document.getElementById('mobileControls');

        // Кнопки управления
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');
        const gasButton = document.getElementById('gasButton');

        // Переменные игры
        let score = 0;
        let level = 1;
        let gameInterval;
        let gameActive = false;

        // Three.js переменные
        let scene, camera, renderer;
        let playerCar, targetParking;
        let obstacles = [];
        let parkingSpots = [];
        
        // Размеры игрового поля
        const FIELD_WIDTH = 25;
        const FIELD_HEIGHT = 18;
        
        // Размеры машины
        const CAR_WIDTH = 1.5;
        const CAR_HEIGHT = 0.8;
        const CAR_LENGTH = 3;
        
        // Размеры парковочного места
        const PARKING_WIDTH = 2.5;
        const PARKING_LENGTH = 4;

        // Физика машины
        const carPhysics = {
            position: { x: 0, z: 0 },
            velocity: { x: 0, z: 0 },
            rotation: 0,
            speed: 0.05, // Базовая скорость
            maxSpeed: 0.15,
            steering: 0.03,
            braking: 0.1,
            gasPressed: false
        };

        // Клавиши управления
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            KeyA: false,
            KeyD: false,
            KeyW: false
        };

        // Мобильное управление
        const mobileInput = {
            steering: 0,
            gas: false
        };

        // Переменные для кнопок управления
        let activeSteering = 0;
        let activeGas = false;

        // Адаптация управления под размер экрана
        function adaptControlsToScreen() {
            const screenWidth = window.innerWidth;
            
            if (screenWidth < 400) {
                carPhysics.steering = 0.025;
            } else if (screenWidth < 768) {
                carPhysics.steering = 0.03;
            } else {
                carPhysics.steering = 0.035;
            }
        }

        // Показать уведомление
        function showNotification(text, type = 'info') {
            notification.textContent = text;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
            } else {
                notification.style.background = 'var(--dark-bg)';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Показать эффект успеха
        function showSuccessEffect() {
            successEffect.style.display = 'block';
            setTimeout(() => {
                successEffect.style.display = 'none';
            }, 2000);
        }

        // Настройка кнопочного управления
        function setupMobileControls() {
            // Функции для обработки нажатий кнопок
            const handleButtonPress = (direction) => {
                switch (direction) {
                    case 'left':
                        activeSteering = 1;
                        break;
                    case 'right':
                        activeSteering = -1;
                        break;
                    case 'gas':
                        activeGas = true;
                        break;
                }
            };

            const handleButtonRelease = (direction) => {
                switch (direction) {
                    case 'left':
                    case 'right':
                        activeSteering = 0;
                        break;
                    case 'gas':
                        activeGas = false;
                        break;
                }
            };

            // Обработчики для кнопок (касания)
            const setupButton = (button, direction) => {
                // Касания
                button.addEventListener('touchstart', (e) => {
                    handleButtonPress(direction);
                    e.preventDefault();
                });

                button.addEventListener('touchend', (e) => {
                    handleButtonRelease(direction);
                    e.preventDefault();
                });

                button.addEventListener('touchcancel', (e) => {
                    handleButtonRelease(direction);
                    e.preventDefault();
                });

                // Мышь (для тестирования)
                button.addEventListener('mousedown', (e) => {
                    handleButtonPress(direction);
                    e.preventDefault();
                });

                button.addEventListener('mouseup', (e) => {
                    handleButtonRelease(direction);
                    e.preventDefault();
                });

                button.addEventListener('mouseleave', (e) => {
                    handleButtonRelease(direction);
                    e.preventDefault();
                });
            };

            // Настройка кнопок
            setupButton(leftButton, 'left');
            setupButton(rightButton, 'right');
            setupButton(gasButton, 'gas');
        }

        // Инициализация Three.js сцены
        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            camera = new THREE.PerspectiveCamera(
                75,
                gameCanvas.clientWidth / gameCanvas.clientHeight, 
                0.1, 
                1000
            );
            
            camera.position.set(0, 12, 12);
            camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: gameCanvas, 
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(gameCanvas.clientWidth, gameCanvas.clientHeight);
            renderer.shadowMap.enabled = true;
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            createGameField();
            createPlayerCar();
            createParkingSpots();
            createObstacles();
            
            animate();
        }

        // Инициализация игры
        function initGame() {
            score = 0;
            level = 1;
            updateUI();
            
            if (scene) {
                while(scene.children.length > 0) { 
                    scene.remove(scene.children[0]); 
                }
            }
            
            initScene();
            
            gameActive = true;
            showNotification('Игра началась! Используйте кнопки для управления машиной 🅿️', 'info');
        }

        // Создание игрового поля
        function createGameField() {
            const groundGeometry = new THREE.PlaneGeometry(FIELD_WIDTH, FIELD_HEIGHT);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x3a7d3a });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            const borderGeometry = new THREE.BoxGeometry(FIELD_WIDTH, 1, 1);
            const borderMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            
            const topBorder = new THREE.Mesh(borderGeometry, borderMaterial);
            topBorder.position.set(0, 0.5, -FIELD_HEIGHT/2);
            scene.add(topBorder);
            
            const bottomBorder = new THREE.Mesh(borderGeometry, borderMaterial);
            bottomBorder.position.set(0, 0.5, FIELD_HEIGHT/2);
            scene.add(bottomBorder);
            
            const leftBorder = new THREE.Mesh(borderGeometry, borderMaterial);
            leftBorder.rotation.y = Math.PI / 2;
            leftBorder.position.set(-FIELD_WIDTH/2, 0.5, 0);
            scene.add(leftBorder);
            
            const rightBorder = new THREE.Mesh(borderGeometry, borderMaterial);
            rightBorder.rotation.y = Math.PI / 2;
            rightBorder.position.set(FIELD_WIDTH/2, 0.5, 0);
            scene.add(rightBorder);
        }

        // Создание машины игрока
        function createPlayerCar() {
            const carGroup = new THREE.Group();
            
            const bodyGeometry = new THREE.BoxGeometry(CAR_WIDTH, CAR_HEIGHT, CAR_LENGTH);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xff4444 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            body.position.y = CAR_HEIGHT / 2;
            carGroup.add(body);
            
            const cabinGeometry = new THREE.BoxGeometry(CAR_WIDTH * 0.8, CAR_HEIGHT * 0.8, CAR_LENGTH * 0.5);
            const cabinMaterial = new THREE.MeshLambertMaterial({ color: 0x4444ff });
            const cabin = new THREE.Mesh(cabinGeometry, cabinMaterial);
            cabin.castShadow = true;
            cabin.position.set(0, CAR_HEIGHT, -CAR_LENGTH * 0.2);
            carGroup.add(cabin);
            
            const wheelGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.15, 8);
            const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            
            const frontLeftWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            frontLeftWheel.rotation.z = Math.PI / 2;
            frontLeftWheel.position.set(-CAR_WIDTH/2, 0.15, CAR_LENGTH/3);
            carGroup.add(frontLeftWheel);
            
            const frontRightWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            frontRightWheel.rotation.z = Math.PI / 2;
            frontRightWheel.position.set(CAR_WIDTH/2, 0.15, CAR_LENGTH/3);
            carGroup.add(frontRightWheel);
            
            const rearLeftWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            rearLeftWheel.rotation.z = Math.PI / 2;
            rearLeftWheel.position.set(-CAR_WIDTH/2, 0.15, -CAR_LENGTH/3);
            carGroup.add(rearLeftWheel);
            
            const rearRightWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            rearRightWheel.rotation.z = Math.PI / 2;
            rearRightWheel.position.set(CAR_WIDTH/2, 0.15, -CAR_LENGTH/3);
            carGroup.add(rearRightWheel);
            
            scene.add(carGroup);
            playerCar = carGroup;
            
            carPhysics.position.x = -FIELD_WIDTH/2 + 3;
            carPhysics.position.z = -FIELD_HEIGHT/2 + 3;
            carPhysics.rotation = 0;
            updateCarPosition();
        }

        // Создание парковочных мест
        function createParkingSpots() {
            parkingSpots.forEach(spot => scene.remove(spot));
            parkingSpots = [];
            
            const spotsCount = 2 + level;
            
            for (let i = 0; i < spotsCount; i++) {
                const parkingGroup = new THREE.Group();
                
                const spotGeometry = new THREE.PlaneGeometry(PARKING_WIDTH, PARKING_LENGTH);
                const spotMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.8
                });
                const spot = new THREE.Mesh(spotGeometry, spotMaterial);
                spot.rotation.x = -Math.PI / 2;
                spot.receiveShadow = true;
                parkingGroup.add(spot);
                
                const borderGeometry = new THREE.BoxGeometry(PARKING_WIDTH, 0.1, 0.1);
                const borderMaterial = new THREE.MeshLambertMaterial({ color: 0xffff00 });
                
                const topBorder = new THREE.Mesh(borderGeometry, borderMaterial);
                topBorder.position.set(0, 0.05, PARKING_LENGTH/2);
                parkingGroup.add(topBorder);
                
                const bottomBorder = new THREE.Mesh(borderGeometry, borderMaterial);
                bottomBorder.position.set(0, 0.05, -PARKING_LENGTH/2);
                parkingGroup.add(bottomBorder);
                
                const leftBorder = new THREE.Mesh(borderGeometry, borderMaterial);
                leftBorder.rotation.y = Math.PI / 2;
                leftBorder.position.set(-PARKING_WIDTH/2, 0.05, 0);
                parkingGroup.add(leftBorder);
                
                const rightBorder = new THREE.Mesh(borderGeometry, borderMaterial);
                rightBorder.rotation.y = Math.PI / 2;
                rightBorder.position.set(PARKING_WIDTH/2, 0.05, 0);
                parkingGroup.add(rightBorder);
                
                let x, z;
                let validPosition = false;
                let attempts = 0;
                
                while (!validPosition && attempts < 50) {
                    x = (Math.random() * (FIELD_WIDTH - PARKING_WIDTH - 6)) - (FIELD_WIDTH - PARKING_WIDTH - 6)/2;
                    z = (Math.random() * (FIELD_HEIGHT - PARKING_LENGTH - 6)) - (FIELD_HEIGHT - PARKING_LENGTH - 6)/2;
                    
                    const distance = Math.sqrt(
                        Math.pow(x - carPhysics.position.x, 2) + 
                        Math.pow(z - carPhysics.position.z, 2)
                    );
                    
                    if (distance > 6) {
                        validPosition = true;
                    }
                    attempts++;
                }
                
                if (validPosition) {
                    parkingGroup.position.set(x, 0.01, z);
                    scene.add(parkingGroup);
                    parkingSpots.push(parkingGroup);
                }
            }
            
            if (parkingSpots.length > 0) {
                targetParking = parkingSpots[Math.floor(Math.random() * parkingSpots.length)];
                targetParking.children[0].material.color.set(0xffff00);
                targetParking.children[0].material.opacity = 1;
            }
        }

        // Создание препятствий
        function createObstacles() {
            obstacles.forEach(obstacle => scene.remove(obstacle));
            obstacles = [];
            
            const obstaclesCount = Math.min(level, 3);
            
            for (let i = 0; i < obstaclesCount; i++) {
                const width = 0.8 + Math.random() * 2;
                const height = 0.8 + Math.random() * 1.5;
                const depth = 0.8 + Math.random() * 2;
                
                const obstacleGeometry = new THREE.BoxGeometry(width, height, depth);
                const obstacleMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
                const obstacle = new THREE.Mesh(obstacleGeometry, obstacleMaterial);
                obstacle.castShadow = true;
                obstacle.receiveShadow = true;
                
                let x, z;
                let validPosition = false;
                let attempts = 0;
                
                while (!validPosition && attempts < 50) {
                    x = (Math.random() * (FIELD_WIDTH - width - 8)) - (FIELD_WIDTH - width - 8)/2;
                    z = (Math.random() * (FIELD_HEIGHT - depth - 8)) - (FIELD_HEIGHT - depth - 8)/2;
                    
                    const distanceToPlayer = Math.sqrt(
                        Math.pow(x - carPhysics.position.x, 2) + 
                        Math.pow(z - carPhysics.position.z, 2)
                    );
                    
                    let farEnoughFromSpots = true;
                    
                    for (const spot of parkingSpots) {
                        const spotX = spot.position.x;
                        const spotZ = spot.position.z;
                        const distanceToSpot = Math.sqrt(
                            Math.pow(x - spotX, 2) + 
                            Math.pow(z - spotZ, 2)
                        );
                        
                        if (distanceToSpot < 4) {
                            farEnoughFromSpots = false;
                            break;
                        }
                    }
                    
                    if (distanceToPlayer > 4 && farEnoughFromSpots) {
                        validPosition = true;
                    }
                    attempts++;
                }
                
                if (validPosition) {
                    obstacle.position.set(x, height/2, z);
                    scene.add(obstacle);
                    obstacles.push(obstacle);
                }
            }
        }

        // Обновление позиции машины
        function updateCarPosition() {
            if (playerCar) {
                playerCar.position.x = carPhysics.position.x;
                playerCar.position.z = carPhysics.position.z;
                playerCar.rotation.y = carPhysics.rotation;
            }
        }

        // Обновление интерфейса
        function updateUI() {
            scoreElement.textContent = score;
            levelElement.textContent = level;
        }

        // Проверка столкновений
        function checkCollisions() {
            if (!gameActive || !playerCar) return;
            
            for (const obstacle of obstacles) {
                const obstacleBox = new THREE.Box3().setFromObject(obstacle);
                const carBox = new THREE.Box3().setFromObject(playerCar);
                
                if (obstacleBox.intersectsBox(carBox)) {
                    showNotification('💥 Столкновение! Попробуйте снова', 'warning');
                    resetCarPosition();
                    return;
                }
            }
            
            if (targetParking) {
                const parkingBox = new THREE.Box3().setFromObject(targetParking);
                const carBox = new THREE.Box3().setFromObject(playerCar);
                
                if (parkingBox.intersectsBox(carBox)) {
                    const angleDiff = Math.abs(carPhysics.rotation);
                    const normalizedAngle = Math.abs((angleDiff + Math.PI) % (2 * Math.PI) - Math.PI);
                    
                    if (normalizedAngle < 0.5 || normalizedAngle > 5.8) {
                        score += 10 * level;
                        level++;
                        updateUI();
                        
                        showNotification(`🎉 Успешная парковка! Уровень ${level}`, 'success');
                        showSuccessEffect();
                        
                        resetCarPosition();
                        createParkingSpots();
                        createObstacles();
                    } else {
                        showNotification('🔄 Поверните машину параллельно парковочному месту', 'info');
                    }
                }
            }
        }

        // Сброс позиции машины
        function resetCarPosition() {
            carPhysics.position.x = -FIELD_WIDTH/2 + 3;
            carPhysics.position.z = -FIELD_HEIGHT/2 + 3;
            carPhysics.rotation = 0;
            updateCarPosition();
        }

        // Игровой цикл
        function gameLoop() {
            if (!gameActive) return;
            
            let steering = 0;
            
            // Управление поворотом с кнопок
            if (keys.ArrowLeft || keys.KeyA) {
                steering = carPhysics.steering;
            } else if (keys.ArrowRight || keys.KeyD) {
                steering = -carPhysics.steering;
            } else {
                // Используем активное управление с кнопок
                steering = activeSteering * carPhysics.steering;
            }
            
            // Управление газом с клавиатуры и кнопок
            const gasPressed = keys.ArrowUp || keys.KeyW || activeGas;
            
            // Машина едет только при нажатии газа
            let currentSpeed = 0;
            if (gasPressed) {
                currentSpeed = carPhysics.speed;
            }
            
            carPhysics.rotation += steering;
            
            // Обновление позиции (только при нажатии газа)
            carPhysics.velocity.x = Math.sin(carPhysics.rotation) * currentSpeed;
            carPhysics.velocity.z = Math.cos(carPhysics.rotation) * currentSpeed;
            
            carPhysics.position.x += carPhysics.velocity.x;
            carPhysics.position.z += carPhysics.velocity.z;
            
            // Ограничение движения в пределах игрового поля
            const halfCarWidth = CAR_WIDTH / 2;
            const halfCarLength = CAR_LENGTH / 2;
            
            carPhysics.position.x = Math.max(
                -FIELD_WIDTH/2 + halfCarWidth, 
                Math.min(FIELD_WIDTH/2 - halfCarWidth, carPhysics.position.x)
            );
            carPhysics.position.z = Math.max(
                -FIELD_HEIGHT/2 + halfCarLength, 
                Math.min(FIELD_HEIGHT/2 - halfCarLength, carPhysics.position.z)
            );
            
            updateCarPosition();
            checkCollisions();
        }

        // Анимационный цикл Three.js
        function animate() {
            requestAnimationFrame(animate);
            
            if (gameActive && playerCar && camera) {
                const carX = carPhysics.position.x;
                const carZ = carPhysics.position.z;
                
                camera.position.x = carX;
                camera.position.z = carZ + 12;
                camera.lookAt(carX, 0, carZ);
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // Обработчики событий для клавиатуры
        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.code)) {
                keys[e.code] = true;
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.code)) {
                keys[e.code] = false;
                e.preventDefault();
            }
        });

        // Обработчик изменения размера окна
        function handleResize() {
            if (camera && renderer && gameCanvas) {
                camera.aspect = gameCanvas.clientWidth / gameCanvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(gameCanvas.clientWidth, gameCanvas.clientHeight);
                
                if (gameActive) {
                    initScene();
                }
            }
        }

        window.addEventListener('resize', handleResize);

        startButton.addEventListener('click', () => {
            if (!gameActive) {
                initGame();
                gameActive = true;
                gameInterval = setInterval(gameLoop, 16);
                startButton.textContent = 'Перезапустить';
            } else {
                clearInterval(gameInterval);
                initGame();
                gameActive = true;
                gameInterval = setInterval(gameLoop, 16);
                showNotification('Игра перезапущена!', 'info');
            }
        });

        // Предотвращение контекстного меню
        document.addEventListener('contextmenu', (e) => {
            if (e.target.closest('.mobile-controls')) {
                e.preventDefault();
            }
        });

        // Инициализация при загрузке страницы
        window.addEventListener('load', () => {
            initScene();
            setupMobileControls();
            adaptControlsToScreen();
            handleResize();
            showNotification('Добро пожаловать! Используйте кнопки для управления машиной 🚗', 'info');
            
            // Автозапуск на мобильных устройствах
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                setTimeout(() => {
                    if (!gameActive) {
                        startButton.click();
                    }
                }, 1000);
            }
        });

        // Предотвращение zoom на iOS
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) {
                e.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>